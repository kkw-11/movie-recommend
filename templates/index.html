<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .movie-card {
            transition: transform 0.2s;
        }
        .movie-card:hover {
            transform: translateY(-5px);
        }
        .selected {
            border: 3px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- í—¤ë” -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold mb-4">ğŸ¬ ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ</h1>
            <p class="text-xl text-gray-400">ì¢‹ì•„í•˜ëŠ” ì˜í™”ë¥¼ 3ê°œ ì´ìƒ ì„ íƒí•˜ê³  ì¶”ì²œë°›ìœ¼ì„¸ìš”</p>
        </header>

        <!-- Step 1: ì˜í™” ê²€ìƒ‰ ë° ì„ íƒ -->
        <div id="step1" class="mb-12">
            <div class="bg-gray-800 rounded-lg p-8">
                <h2 class="text-3xl font-bold mb-6">1ë‹¨ê³„: ì¢‹ì•„í•˜ëŠ” ì˜í™” ì„ íƒ</h2>
                
                <!-- ê²€ìƒ‰ì°½ -->
                <div class="mb-8">
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="ì˜í™” ì œëª©ì„ ê²€ìƒ‰í•˜ì„¸ìš”... (ì˜ˆ: ì¸ì…‰ì…˜, íƒ€ì´íƒ€ë‹‰)"
                        class="w-full px-6 py-4 bg-gray-700 rounded-lg text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <div id="searchStatus" class="mt-2 text-sm text-gray-400"></div>
                </div>

                <!-- ê²€ìƒ‰ ê²°ê³¼ -->
                <div id="searchResults" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8"></div>

                <!-- ì„ íƒí•œ ì˜í™” -->
                <div id="selectedSection" class="hidden">
                    <h3 class="text-2xl font-bold mb-4">
                        ì„ íƒí•œ ì˜í™” (<span id="selectedCount">0</span>ê°œ)
                    </h3>
                    <div id="selectedMovies" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6"></div>
                    
                    <button 
                        id="getRecommendationsBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        ì¶”ì²œ ë°›ê¸° (ìµœì†Œ 3ê°œ ì„ íƒ)
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: ì¶”ì²œ ê²°ê³¼ -->
        <div id="step2" class="hidden">
            <div class="bg-gray-800 rounded-lg p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">ğŸ¯ ì¶”ì²œ ì˜í™”</h2>
                    <button 
                        id="resetBtn"
                        class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg"
                    >
                        ë‹¤ì‹œ ì„ íƒí•˜ê¸°
                    </button>
                </div>

                <!-- ë¡œë”© -->
                <div id="loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                    <p class="mt-4 text-xl text-gray-400">ì¶”ì²œ ì˜í™”ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>

                <!-- ì¶”ì²œ ê²°ê³¼ -->
                <div id="recommendations" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 hidden"></div>
            </div>
        </div>

        <!-- ì˜í™” ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
        <div id="movieModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div id="movieDetails" class="p-6"></div>
                <div class="p-6 pt-0">
                    <button 
                        onclick="closeModal()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg"
                    >
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let searchTimeout = null;
        let selectedMovies = new Set();

        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchStatus = document.getElementById('searchStatus');
        const selectedSection = document.getElementById('selectedSection');
        const selectedMoviesList = document.getElementById('selectedMovies');
        const selectedCount = document.getElementById('selectedCount');
        const getRecommendationsBtn = document.getElementById('getRecommendationsBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const loading = document.getElementById('loading');
        const recommendations = document.getElementById('recommendations');
        const resetBtn = document.getElementById('resetBtn');
        const movieModal = document.getElementById('movieModal');
        const movieDetails = document.getElementById('movieDetails');

        // ê²€ìƒ‰
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchStatus.textContent = '';
                return;
            }

            searchStatus.textContent = 'ê²€ìƒ‰ ì¤‘...';

            searchTimeout = setTimeout(() => {
                searchMovies(query);
            }, 500);
        });

        // ì˜í™” ê²€ìƒ‰
        async function searchMovies(query) {
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    searchStatus.textContent = `${data.total_results}ê°œì˜ ê²°ê³¼`;
                    displaySearchResults(data.results);
                } else {
                    searchStatus.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
                    searchResults.innerHTML = '';
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                searchStatus.textContent = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
            }
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(movies) {
            searchResults.innerHTML = movies.map(movie => `
                <div class="movie-card cursor-pointer ${selectedMovies.has(movie.id) ? 'selected' : ''}" 
                     onclick="toggleMovie(${movie.id}, '${movie.title.replace(/'/g, "\\'")}', '${movie.poster_path || ''}', ${movie.vote_average})">
                    <div class="bg-gray-700 rounded-lg overflow-hidden relative">
                        ${selectedMovies.has(movie.id) ? 
                            '<div class="absolute top-2 right-2 bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl">âœ“</div>' : ''
                        }
                        ${movie.poster_path ? 
                            `<img src="${movie.poster_path}" alt="${movie.title}" class="w-full h-64 object-cover">` :
                            `<div class="w-full h-64 bg-gray-600 flex items-center justify-center text-gray-400">
                                <span class="text-4xl">ğŸ¬</span>
                            </div>`
                        }
                        <div class="p-3">
                            <h3 class="font-bold text-sm truncate mb-1">${movie.title}</h3>
                            <p class="text-yellow-400 text-sm">â­ ${movie.vote_average.toFixed(1)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ì˜í™” ì„ íƒ/í•´ì œ
        function toggleMovie(id, title, poster, rating) {
            if (selectedMovies.has(id)) {
                selectedMovies.delete(id);
            } else {
                selectedMovies.add(id);
            }
            
            // ì„ íƒí•œ ì˜í™” ì •ë³´ ì €ì¥
            if (!window.selectedMoviesData) {
                window.selectedMoviesData = {};
            }
            if (!selectedMovies.has(id)) {
                delete window.selectedMoviesData[id];
            } else {
                window.selectedMoviesData[id] = { id, title, poster, rating };
            }

            updateUI();
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            selectedCount.textContent = selectedMovies.size;
            
            // ì„ íƒí•œ ì˜í™” ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            if (selectedMovies.size > 0) {
                selectedSection.classList.remove('hidden');
                updateSelectedMovies();
            } else {
                selectedSection.classList.add('hidden');
            }

            // ì¶”ì²œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            getRecommendationsBtn.disabled = selectedMovies.size < 3;
            if (selectedMovies.size < 3) {
                getRecommendationsBtn.textContent = `ì¶”ì²œ ë°›ê¸° (${selectedMovies.size}/3)`;
            } else {
                getRecommendationsBtn.textContent = `ì¶”ì²œ ë°›ê¸° (${selectedMovies.size}ê°œ ì„ íƒë¨)`;
            }

            // ê²€ìƒ‰ ê²°ê³¼ ì—…ë°ì´íŠ¸
            displaySearchResults(
                Array.from(document.querySelectorAll('#searchResults .movie-card'))
                    .map(el => {
                        const id = parseInt(el.getAttribute('onclick').match(/\d+/)[0]);
                        return { 
                            id,
                            selected: selectedMovies.has(id)
                        };
                    })
            );
        }

        // ì„ íƒí•œ ì˜í™” ëª©ë¡ í‘œì‹œ
        function updateSelectedMovies() {
            const movies = Array.from(selectedMovies).map(id => window.selectedMoviesData[id]);
            
            selectedMoviesList.innerHTML = movies.map(movie => `
                <div class="bg-gray-700 rounded-lg overflow-hidden relative">
                    <button 
                        onclick="toggleMovie(${movie.id}, '${movie.title.replace(/'/g, "\\'")}', '${movie.poster}', ${movie.rating})"
                        class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-8 h-8 flex items-center justify-center z-10"
                    >
                        âœ•
                    </button>
                    ${movie.poster ? 
                        `<img src="${movie.poster}" alt="${movie.title}" class="w-full h-64 object-cover">` :
                        `<div class="w-full h-64 bg-gray-600 flex items-center justify-center text-gray-400">
                            <span class="text-4xl">ğŸ¬</span>
                        </div>`
                    }
                    <div class="p-3">
                        <h3 class="font-bold text-sm truncate">${movie.title}</h3>
                        <p class="text-yellow-400 text-sm">â­ ${movie.rating.toFixed(1)}</p>
                    </div>
                </div>
            `).join('');
        }

        // ì¶”ì²œ ë°›ê¸°
        getRecommendationsBtn.addEventListener('click', async () => {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            loading.classList.remove('hidden');
            recommendations.classList.add('hidden');

            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        movie_ids: Array.from(selectedMovies)
                    })
                });

                const data = await response.json();
                
                loading.classList.add('hidden');
                recommendations.classList.remove('hidden');
                displayRecommendations(data.recommendations);
            } catch (error) {
                console.error('ì¶”ì²œ ì˜¤ë¥˜:', error);
                alert('ì¶”ì²œì„ ë°›ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        });

        // ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
        function displayRecommendations(movies) {
            recommendations.innerHTML = movies.map(movie => `
                <div class="movie-card cursor-pointer" onclick="showMovieDetails(${movie.id})">
                    <div class="bg-gray-700 rounded-lg overflow-hidden">
                        ${movie.poster_path ? 
                            `<img src="${movie.poster_path}" alt="${movie.title}" class="w-full h-64 object-cover">` :
                            `<div class="w-full h-64 bg-gray-600 flex items-center justify-center text-gray-400">
                                <span class="text-4xl">ğŸ¬</span>
                            </div>`
                        }
                        <div class="p-3">
                            <h3 class="font-bold text-sm truncate mb-1">${movie.title}</h3>
                            <p class="text-yellow-400 text-sm">â­ ${movie.vote_average.toFixed(1)}</p>
                            <p class="text-xs text-gray-400">${movie.genres.slice(0, 2).join(', ')}</p>
                            <p class="text-xs text-blue-400 mt-1">ìœ ì‚¬ë„: ${(movie.similarity_score * 100).toFixed(0)}%</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ì˜í™” ìƒì„¸ ì •ë³´
        async function showMovieDetails(movieId) {
            try {
                const response = await fetch(`/api/movie/${movieId}`);
                const movie = await response.json();

                movieDetails.innerHTML = `
                    <div class="space-y-4">
                        ${movie.poster_path ? 
                            `<img src="${movie.poster_path}" alt="${movie.title}" class="w-full max-h-96 object-contain rounded-lg">` :
                            ''
                        }
                        
                        <h2 class="text-3xl font-bold">${movie.title}</h2>
                        
                        ${movie.original_title !== movie.title ? 
                            `<p class="text-gray-400">${movie.original_title}</p>` : ''
                        }
                        
                        <div class="flex items-center space-x-4 text-sm">
                            <span class="text-yellow-400">â­ ${movie.vote_average.toFixed(1)}</span>
                            <span class="text-gray-400">${movie.release_date}</span>
                            <span class="text-gray-400">${movie.runtime}ë¶„</span>
                        </div>
                        
                        ${movie.genres.length > 0 ? 
                            `<div class="flex flex-wrap gap-2">
                                ${movie.genres.map(genre => 
                                    `<span class="bg-blue-600 px-3 py-1 rounded-full text-sm">${genre}</span>`
                                ).join('')}
                            </div>` : ''
                        }
                        
                        ${movie.directors.length > 0 ? 
                            `<div>
                                <h3 class="font-bold mb-2">ê°ë…</h3>
                                <p class="text-gray-300">${movie.directors.join(', ')}</p>
                            </div>` : ''
                        }
                        
                        ${movie.cast.length > 0 ? 
                            `<div>
                                <h3 class="font-bold mb-2">ì¶œì—°</h3>
                                <p class="text-gray-300">${movie.cast.join(', ')}</p>
                            </div>` : ''
                        }
                        
                        ${movie.overview ? 
                            `<div>
                                <h3 class="font-bold mb-2">ì¤„ê±°ë¦¬</h3>
                                <p class="text-gray-300 leading-relaxed">${movie.overview}</p>
                            </div>` : ''
                        }
                    </div>
                `;

                movieModal.classList.remove('hidden');
            } catch (error) {
                console.error('ì˜í™” ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            movieModal.classList.add('hidden');
        }

        // ë‹¤ì‹œ ì„ íƒí•˜ê¸°
        resetBtn.addEventListener('click', () => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            searchInput.value = '';
            searchResults.innerHTML = '';
            searchStatus.textContent = '';
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
