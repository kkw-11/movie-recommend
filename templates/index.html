<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .movie-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .movie-card:hover {
            transform: translateY(-8px);
        }
        
        .movie-card:hover .movie-poster {
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
        }
        
        .selected {
            border: 3px solid #3b82f6;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
        }
        
        .badge {
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-footer {
            animation: fadeInUp 0.7s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- í—¤ë” -->
        <header class="text-center mb-12">
            <h1 class="text-6xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                ğŸ¬ ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ
            </h1>
            <p class="text-xl text-gray-300">ì¢‹ì•„í•˜ëŠ” ì˜í™”ë¥¼ 3ê°œ ì´ìƒ ì„ íƒí•˜ê³  ì¶”ì²œë°›ìœ¼ì„¸ìš”</p>
        </header>

        <!-- Step 1: ì˜í™” ê²€ìƒ‰ ë° ì„ íƒ -->
        <div id="step1" class="mb-12">
            <div class="bg-gray-800/50 backdrop-blur-xl rounded-2xl p-8 border border-gray-700/50">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                    <span class="text-blue-400">1ï¸âƒ£</span>
                    ì¢‹ì•„í•˜ëŠ” ì˜í™” ì„ íƒ
                </h2>
                
                <!-- ê²€ìƒ‰ì°½ -->
                <div class="mb-8">
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="ì˜í™” ì œëª©ì„ ê²€ìƒ‰í•˜ì„¸ìš”... (ì˜ˆ: ì¸ì…‰ì…˜, íƒ€ì´íƒ€ë‹‰)"
                        class="w-full px-6 py-4 bg-gray-700/50 backdrop-blur-sm rounded-xl text-white text-lg border border-gray-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all"
                    >
                    <div id="searchStatus" class="mt-3 text-sm text-gray-400"></div>
                </div>

                <!-- ê²€ìƒ‰ ê²°ê³¼ -->
                <div id="searchResults" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 mb-8"></div>

                <!-- ì„ íƒí•œ ì˜í™” -->
                <div id="selectedSection" class="hidden">
                    <div class="border-t border-gray-700 pt-8 mt-8">
                        <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <span class="text-green-400">âœ“</span>
                            ì„ íƒí•œ ì˜í™” 
                            <span class="px-3 py-1 bg-blue-500/20 text-blue-300 text-lg rounded-full border border-blue-500/30">
                                <span id="selectedCount">0</span>ê°œ
                            </span>
                        </h3>
                        <div id="selectedMovies" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 mb-6"></div>
                        
                        <button 
                            id="getRecommendationsBtn"
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-4 px-8 rounded-xl text-xl shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-[1.02]"
                            disabled
                        >
                            ì¶”ì²œ ë°›ê¸° (ìµœì†Œ 3ê°œ ì„ íƒ)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: ì¶”ì²œ ê²°ê³¼ -->
        <div id="step2" class="hidden">
            <div class="bg-gray-800/50 backdrop-blur-xl rounded-2xl p-8 border border-gray-700/50">
                <div class="flex justify-between items-center mb-8">
                    <div id="recommendHeader" class="flex items-center gap-3">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </div>
                    <button 
                        id="resetBtn"
                        class="bg-gray-700/70 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-all border border-gray-600 hover:border-gray-500"
                    >
                        â† ë‹¤ì‹œ ì„ íƒí•˜ê¸°
                    </button>
                </div>

                <!-- ë¡œë”© -->
                <div id="loading" class="text-center py-16">
                    <div class="inline-block animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-blue-500"></div>
                    <p class="mt-6 text-xl text-gray-300 font-medium">ì¶”ì²œ ì˜í™”ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>

                <!-- ì¶”ì²œ ê²°ê³¼ -->
                <div id="recommendations" class="hidden">
                    <div id="recommendMovies" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
                    <div id="recommendFooter" class="mt-10"></div>
                </div>
            </div>
        </div>

        <!-- ì˜í™” ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
        <div id="movieModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-700">
                <div id="movieDetails" class="p-8"></div>
                <div class="px-8 pb-8">
                    <button 
                        onclick="closeModal()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-xl transition-all"
                    >
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let searchTimeout = null;
        let selectedMovies = new Set();
    
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchStatus = document.getElementById('searchStatus');
        const selectedSection = document.getElementById('selectedSection');
        const selectedMoviesList = document.getElementById('selectedMovies');
        const selectedCount = document.getElementById('selectedCount');
        const getRecommendationsBtn = document.getElementById('getRecommendationsBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const loading = document.getElementById('loading');
        const recommendations = document.getElementById('recommendations');
        const recommendHeader = document.getElementById('recommendHeader');
        const recommendMovies = document.getElementById('recommendMovies');
        const recommendFooter = document.getElementById('recommendFooter');
        const resetBtn = document.getElementById('resetBtn');
        const movieModal = document.getElementById('movieModal');
        const movieDetails = document.getElementById('movieDetails');
    
        // ê²€ìƒ‰
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
    
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchStatus.textContent = '';
                return;
            }
    
            searchStatus.textContent = 'ğŸ” ê²€ìƒ‰ ì¤‘...';
    
            searchTimeout = setTimeout(() => {
                searchMovies(query);
            }, 500);
        });
    
        // ì˜í™” ê²€ìƒ‰
        async function searchMovies(query) {
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
    
                if (data.results && data.results.length > 0) {
                    searchStatus.textContent = `âœ“ ${data.total_results}ê°œì˜ ê²°ê³¼`;
                    displaySearchResults(data.results);
                } else {
                    searchStatus.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
                    searchResults.innerHTML = '';
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                searchStatus.textContent = 'âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
            }
        }
    
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(movies) {
            searchResults.innerHTML = movies.map(movie => {
                const movieId = movie.id || 0;
                const movieTitle = (movie.title || 'Unknown').replace(/'/g, "\\'");
                const displayTitle = movie.title || 'Unknown';
                const posterPath = movie.poster_path || '';
                const voteAverage = movie.vote_average || 0;
                const isSelected = selectedMovies.has(movieId);
                
                return `
                    <div class="movie-card cursor-pointer ${isSelected ? 'selected' : ''}" 
                         onclick="toggleMovie(${movieId}, '${movieTitle}', '${posterPath}', ${voteAverage})">
                        <div class="movie-poster bg-gray-700 rounded-xl overflow-hidden relative group">
                            ${isSelected ? 
                                '<div class="absolute top-3 right-3 bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold shadow-lg z-10">âœ“</div>' : ''
                            }
                            ${posterPath ? 
                                `<img src="${posterPath}" alt="${displayTitle}" class="w-full h-72 object-cover group-hover:scale-110 transition-transform duration-500">` :
                                `<div class="w-full h-72 bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center text-gray-400">
                                    <span class="text-5xl">ğŸ¬</span>
                                </div>`
                            }
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="p-4 bg-gradient-to-t from-gray-900 to-gray-800/50">
                                <h3 class="font-bold text-sm truncate mb-2">${displayTitle}</h3>
                                <p class="text-yellow-400 text-sm font-semibold">â­ ${voteAverage.toFixed(1)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    
        // ì˜í™” ì„ íƒ/í•´ì œ
        function toggleMovie(id, title, poster, rating) {
            if (selectedMovies.has(id)) {
                selectedMovies.delete(id);
            } else {
                selectedMovies.add(id);
            }
            
            if (!window.selectedMoviesData) {
                window.selectedMoviesData = {};
            }
            if (!selectedMovies.has(id)) {
                delete window.selectedMoviesData[id];
            } else {
                window.selectedMoviesData[id] = { id, title, poster, rating };
            }
    
            updateUI();
        }
    
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            selectedCount.textContent = selectedMovies.size;
            
            if (selectedMovies.size > 0) {
                selectedSection.classList.remove('hidden');
                updateSelectedMovies();
            } else {
                selectedSection.classList.add('hidden');
            }
    
            getRecommendationsBtn.disabled = selectedMovies.size < 3;
            if (selectedMovies.size < 3) {
                getRecommendationsBtn.textContent = `ì¶”ì²œ ë°›ê¸° (${selectedMovies.size}/3)`;
            } else {
                getRecommendationsBtn.textContent = `ğŸ¯ ì¶”ì²œ ë°›ê¸° (${selectedMovies.size}ê°œ ì„ íƒë¨)`;
            }
    
            const query = searchInput.value.trim();
            if (query.length >= 2) {
                searchMovies(query);
            }
        }
    
        // ì„ íƒí•œ ì˜í™” ëª©ë¡ í‘œì‹œ
        function updateSelectedMovies() {
            const movies = Array.from(selectedMovies).map(id => window.selectedMoviesData[id]).filter(m => m);
            
            selectedMoviesList.innerHTML = movies.map(movie => {
                const safeTitle = (movie.title || 'Unknown').replace(/'/g, "\\'");
                const displayTitle = movie.title || 'Unknown';
                
                return `
                    <div class="movie-card relative group">
                        <div class="bg-gray-700 rounded-xl overflow-hidden relative">
                            <button 
                                onclick="toggleMovie(${movie.id}, '${safeTitle}', '${movie.poster || ''}', ${movie.rating || 0})"
                                class="absolute top-3 right-3 bg-red-500 hover:bg-red-600 text-white rounded-full w-10 h-10 flex items-center justify-center z-10 font-bold text-lg shadow-lg transition-all hover:scale-110"
                            >
                                âœ•
                            </button>
                            ${movie.poster ? 
                                `<img src="${movie.poster}" alt="${displayTitle}" class="w-full h-72 object-cover">` :
                                `<div class="w-full h-72 bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center text-gray-400">
                                    <span class="text-5xl">ğŸ¬</span>
                                </div>`
                            }
                            <div class="p-4 bg-gradient-to-t from-gray-900 to-gray-800/50">
                                <h3 class="font-bold text-sm truncate">${displayTitle}</h3>
                                <p class="text-yellow-400 text-sm font-semibold mt-1">â­ ${(movie.rating || 0).toFixed(1)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    
        // ì¶”ì²œ ë°›ê¸°
        getRecommendationsBtn.addEventListener('click', async () => {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            loading.classList.remove('hidden');
            recommendations.classList.add('hidden');
    
            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie_ids: Array.from(selectedMovies)
                    })
                });
    
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    step2.classList.add('hidden');
                    step1.classList.remove('hidden');
                    return;
                }
                
                loading.classList.add('hidden');
                recommendations.classList.remove('hidden');
                displayRecommendations(data);
            } catch (error) {
                console.error('ì¶”ì²œ ì˜¤ë¥˜:', error);
                alert('ì¶”ì²œì„ ë°›ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            }
        });
    
        // ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
        function displayRecommendations(data) {
            const movies = data.recommendations || [];
            const recommendationType = data.recommendation_type || 'similar';
            
            if (!movies || movies.length === 0) {
                recommendMovies.innerHTML = '<p class="text-center text-gray-400 py-12 text-lg col-span-full">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            // í—¤ë”
            if (recommendationType === 'popular') {
                recommendHeader.innerHTML = `
                    <h2 class="text-3xl font-bold">ğŸ¯ ì¶”ì²œ ì˜í™”</h2>
                    <span class="header-badge px-4 py-2 bg-blue-500/20 text-blue-300 text-base rounded-full border border-blue-500/40 font-semibold">
                        âœ¨ ìµœì‹  ì¸ê¸°ì‘
                    </span>
                `;
            } else {
                recommendHeader.innerHTML = `
                    <h2 class="text-3xl font-bold">ğŸ¯ ì¶”ì²œ ì˜í™”</h2>
                    <span class="header-badge px-4 py-2 bg-green-500/20 text-green-300 text-base rounded-full border border-green-500/40 font-semibold">
                        âœ“ ë§ì¶¤ ì¶”ì²œ
                    </span>
                `;
            }
            
            // ìƒë‹¨ ì•ˆë‚´ (col-span-full ì‚¬ìš©!)
            let topNotice = '';
            if (recommendationType === 'popular') {
                topNotice = `
                    <div class="col-span-full mb-2">
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-5 text-center backdrop-blur-sm animate-fadeIn">
                            <p class="text-gray-200 text-sm leading-relaxed">
                                <span class="inline-block mr-2">ğŸ’¡</span>
                                ì„ íƒí•˜ì‹  ì˜í™”ì™€ ìœ ì‚¬í•œ ì‘í’ˆì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. í‰ì ì´ ë†’ì€ ìµœì‹  ì¸ê¸° ì˜í™”ë¥¼ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // ì˜í™” ì¹´ë“œ
            const movieCards = movies.map(movie => {
                const displayTitle = movie.title || 'Unknown';
                const posterUrl = movie.poster_path || null;
                const voteAverage = movie.vote_average || 0;
                const genres = Array.isArray(movie.genres) ? movie.genres : [];
                const genreText = genres.slice(0, 2).join(', ');
                const similarityScore = movie.similarity_score || 0;
                
                const badge = recommendationType === 'similar' && similarityScore > 0
                    ? `<div class="badge absolute top-3 right-3 bg-green-500/90 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-lg">${(similarityScore * 100).toFixed(0)}%</div>`
                    : '';
                
                return `
                    <div class="movie-card cursor-pointer" onclick="showMovieDetails(${movie.id})">
                        <div class="group bg-gray-700 rounded-xl overflow-hidden relative hover:ring-2 hover:ring-blue-500 transition-all">
                            ${badge}
                            ${posterUrl ? 
                                `<img src="${posterUrl}" alt="${displayTitle}" class="w-full h-72 object-cover group-hover:scale-110 transition-transform duration-500">` :
                                `<div class="w-full h-72 bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center text-gray-400">
                                    <span class="text-5xl">ğŸ¬</span>
                                </div>`
                            }
                            <div class="p-4 bg-gradient-to-t from-gray-900 to-gray-800/50">
                                <h3 class="font-bold text-sm truncate mb-2">${displayTitle}</h3>
                                <div class="flex items-center justify-between text-sm">
                                    <p class="text-yellow-400 font-semibold">â­ ${voteAverage.toFixed(1)}</p>
                                    ${genreText ? `<p class="text-gray-400 text-xs truncate ml-2">${genreText}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ì§ì ‘ ì‚½ì…!
            recommendMovies.innerHTML = topNotice + movieCards;
            recommendFooter.innerHTML = '';
        }
    
        // ì˜í™” ìƒì„¸ ì •ë³´
        async function showMovieDetails(movieId) {
            try {
                const response = await fetch(`/api/movie/${movieId}`);
                const movie = await response.json();
    
                movieDetails.innerHTML = `<p class="text-center text-gray-400">ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...</p>`;
                movieModal.classList.remove('hidden');
            } catch (error) {
                console.error('ì˜í™” ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
    
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            movieModal.classList.add('hidden');
        }
    
        // ë‹¤ì‹œ ì„ íƒí•˜ê¸°
        resetBtn.addEventListener('click', () => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            searchInput.value = '';
            searchResults.innerHTML = '';
            searchStatus.textContent = '';
        });
    
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>